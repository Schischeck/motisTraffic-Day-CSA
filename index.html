<!doctype html>
<html>

<head>
	<title>MOTIS</title>
	<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
	<meta content="utf-8" http-equiv="encoding">
	<link rel="stylesheet" href="external_lib/leaflet.css">
	<link rel="stylesheet" href="external_lib/grid/grids-min.css">
	<link rel="stylesheet" href="external_lib/grid/grids-responsive-min.css">
	<link rel="stylesheet" href="external_lib/grid/grids-gutters.css">
	<link rel="stylesheet" href="style/global.css">
	<link rel="stylesheet" href="style/taglist.css">
	<link rel="stylesheet" href="style/calendar.css">
	<link rel="stylesheet" href="style/time.css">
	<link rel="stylesheet" href="style/button.css">
	<link rel="stylesheet" href="style/input.css">
	<link rel="stylesheet" href="style/typeahead.css">
	<link rel="stylesheet" href="style/map.css">
	<link rel="stylesheet" href="style/loader.css">
	<link rel="stylesheet" href="style/app.css">
</head>

<body>
	<script type="text/javascript" src="external_lib/leaflet.min.js"></script>
	<script type="text/javascript" src="elm.js"></script>
	<script type="text/javascript">
    var CanvasOverlay = L.Class.extend({
      initialize: function () {
        L.setOptions(this, {});
      },

      onAdd: function (map) {
        this._map = map;

        map._panes.overlayPane.appendChild(this._el);

        map.on('dragend', this._updatePosition, this);
        //map.on('move', this._updatePosition, this);
        map.on('resize', this._updateSize, this);
        map.on('zoomend', this._update, this);

        setTimeout(function() {
          app.ports.mapLoaded.send("");
          this._updateSize();
        }.bind(this), 100);
      },

      onRemove: function (map) {
        map.getPanes().overlayPane.removeChild(this._el);
        map.off('dragend', this._updatePosition, this);
        map.off('move', this._updatePosition, this);
        map.off('resize', this._updateSize, this);
        map.off('zoomend', this._update, this);
      },

      _update: function() {
        var bounds = this._map.getPixelBounds().min;
        var size = this._map.getSize();

        app.ports.mapUpdate.send({
          scale: Math.pow(2, this._map.getZoom()),
          zoom: this._map.getZoom(),
          north: bounds.y,
          west: bounds.x,
          width: size.x,
          height: size.y
        });
      },

      _updateSize: function() {
        var size = this._map.getSize();
        this._el.width = size.x;
        this._el.height = size.y;
        this._updatePosition();
      },

      _updatePosition: function()Â {
        this._update();
        var pos = this._map.containerPointToLayerPoint([0, 0]);
        L.DomUtil.setPosition(this._el, pos);
      }
    });
  </script>

	<script type="text/javascript">
  var app = Elm.Main.fullscreen()

  window.elmMaps = {};

  app.ports.mapInit.subscribe(function(id) {
    var map = L.map('map').setView([49.8728, 8.6512], 14);

    L.tileLayer('https://tiles.motis-project.de/osm_light/{z}/{x}/{y}.png?token={accessToken}', {
      attribution: 'Map data &copy; OpenStreetMap contributors, CC-BY-SA',
      maxZoom: 18,
      accessToken: '862bdec137edd4e88029304609458291f0ec760b668c5816ccdd83d0beae76a4'
    }).addTo(map);

    window.elmMaps[id] = map;

    var c = new CanvasOverlay();
    c._el = map.getContainer().querySelector('.leaflet-overlay');
    map.addLayer(c);
  });
  </script>
</body>

</html>